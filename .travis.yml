dist: trusty
language: cpp
services: docker

os: linux

cache:
  directories:
    - $HOME/.ccache
    - $HOME/Library/Caches/Homebrew

stages:
  - test # Default stage with job matrix
  - osx

env:
  global:
    - TRAVIS_CMAKE_GENERATOR="Unix Makefiles"

matrix:
  include:
    - os: linux
      compiler: gcc
      env: TRAVIS_BUILD_TYPE="Release" DOCKER_REPO="ubuntu" DOCKER_TAG="xenial"
    - os: linux
      compiler: clang
      env: TRAVIS_BUILD_TYPE="Debug" DOCKER_REPO="ubuntu" DOCKER_TAG="xenial"
    - os: linux
      compiler: clang
      env: TRAVIS_BUILD_TYPE="Release" DOCKER_REPO="ubuntu" DOCKER_TAG="bionic"
    - os: linux
      compiler: gcc
      env: TRAVIS_BUILD_TYPE="Debug" DOCKER_REPO="ubuntu" DOCKER_TAG="bionic"
    - os: linux
      compiler: gcc
      env: TRAVIS_BUILD_TYPE="Release" DOCKER_REPO="debian" DOCKER_TAG="stable"
    - os: linux
      compiler: clang
      env: TRAVIS_BUILD_TYPE="Debug" DOCKER_REPO="debian" DOCKER_TAG="sid"

# ===================
# STAGE: test (linux)
# ===================

before_script:
  - docker pull $DOCKER_REPO:$DOCKER_TAG

script:
  - >-
    docker run -it \
      -v $TRAVIS_BUILD_DIR:$TRAVIS_BUILD_DIR \
      -v $HOME/.ccache:$HOME/.ccache \
      -w $TRAVIS_BUILD_DIR \
      --env CC \
      --env CXX \
      --env TRAVIS_BUILD_DIR \
      --env TRAVIS_BUILD_TYPE \
      --env TRAVIS_CMAKE_GENERATOR \
      $DOCKER_REPO:$DOCKER_TAG \
      sh .ci/install_debian_and_script.sh

# ==========
# STAGE: osx
# ==========

stage_osx:
  install: &osx_install
    # Setup ccache
    - brew update
    - brew install ccache
    - export PATH="/usr/local/opt/ccache/libexec:$PATH"
    # Install dependencies
    - brew install ace eigen cmake boost tinyxml swig qt5 gsl pkg-config jpeg sqlite readline tinyxml
    - export Qt5_DIR=/usr/local/opt/qt5/lib/cmake/Qt5
  script: &osx_script
    - cd $TRAVIS_BUILD_DIR/.ci
    - ./script.sh

# ======================
# BUILD JOBS FROM STAGES
# ======================

jobs:
  include:
    # ---------
    # STAGE OSX
    # ---------
    - &osx_template
      stage: osx
      os: osx
      osx_image: xcode9.3
      before_install: skip
      install: *osx_install
      before_script: skip
      script: *osx_script
      after_failure: skip
      after_success: skip
      after_script: skip
      env:
        TRAVIS_CMAKE_GENERATOR="Xcode"
        TRAVIS_BUILD_TYPE="Debug"
    - <<: *osx_template
      compiler: clang
      env:
        TRAVIS_CMAKE_GENERATOR="Unix Makefiles"
        TRAVIS_BUILD_TYPE="Debug"


notifications:
  email:
    # CORE, DYNAMICS mantainer
    - pegua1@gmail.com
    # IHMC mantainer
    - gabriele.nava@mail.polimi.it
